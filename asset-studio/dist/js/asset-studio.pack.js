/*
Copyright 2010 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
var Base=function(){};Base.extend=function(b,e){var f=Base.prototype.extend;Base._prototyping=true;var d=new this;f.call(d,b);delete Base._prototyping;var c=d.constructor;var a=d.constructor=function(){if(!Base._prototyping){if(this._constructing||this.constructor==a){this._constructing=true;c.apply(this,arguments);delete this._constructing}else{if(arguments[0]!=null){return(arguments[0].extend||f).call(arguments[0],d)}}}};a.ancestor=this;a.extend=this.extend;a.forEach=this.forEach;a.implement=this.implement;a.prototype=d;a.toString=this.toString;a.valueOf=function(g){return(g=="object")?a:c.valueOf()};f.call(a,e);if(typeof a.init=="function"){a.init()}return a};Base.prototype={extend:function(b,h){if(arguments.length>1){var e=this[b];if(e&&(typeof h=="function")&&(!e.valueOf||e.valueOf()!=h.valueOf())&&/\bbase\b/.test(h)){var a=h.valueOf();h=function(){var l=this.base||Base.prototype.base;this.base=e;var i=a.apply(this,arguments);this.base=l;return i};h.valueOf=function(i){return(i=="object")?h:a};h.toString=Base.toString}this[b]=h}else{if(b){var g=Base.prototype.extend;if(!Base._prototyping&&typeof this!="function"){g=this.extend||g}var d={toSource:null};var f=["constructor","toString","valueOf"];var c=Base._prototyping?0:1;while(j=f[c++]){if(b[j]!=d[j]){g.call(this,j,b[j])}}for(var j in b){if(!d[j]){g.call(this,j,b[j])}}}}return this},base:function(){}};Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(a,d,c){for(var b in a){if(this.prototype[b]===undefined){d.call(c,a[b],b,a)}}},implement:function(){for(var a=0;a<arguments.length;a++){if(typeof arguments[a]=="function"){arguments[a](this.prototype)}else{this.prototype.extend(arguments[a])}}return this},toString:function(){return String(this.valueOf())}});(function(){var imagelib={};var Class={create:function(){var properties=arguments[0];function self(){this.initialize.apply(this,arguments)}for(var i in properties){self.prototype[i]=properties[i]}if(!self.prototype.initialize){self.prototype.initialize=function(){}}return self}};var ConvolutionFilter=Class.create({initialize:function(matrix,divisor,bias,separable){this.r=(Math.sqrt(matrix.length)-1)/2;this.matrix=matrix;this.divisor=divisor;this.bias=bias;this.separable=separable},apply:function(src,dst){var w=src.width,h=src.height;var srcData=src.data;var dstData=dst.data;var di,si,idx;var r,g,b;for(var y=0;y<h;++y){for(var x=0;x<w;++x){idx=r=g=b=0;di=(y*w+x)<<2;for(var ky=-this.r;ky<=this.r;++ky){for(var kx=-this.r;kx<=this.r;++kx){si=(Math.max(0,Math.min(h-1,y+ky))*w+Math.max(0,Math.min(w-1,x+kx)))<<2;r+=srcData[si]*this.matrix[idx];g+=srcData[si+1]*this.matrix[idx];b+=srcData[si+2]*this.matrix[idx];idx++}}dstData[di]=r/this.divisor+this.bias;dstData[di+1]=g/this.divisor+this.bias;dstData[di+2]=b/this.divisor+this.bias;dstData[di+3]=255}}}});imagelib.drawing={};imagelib.drawing.context=function(size){var canvas=document.createElement("canvas");canvas.width=size.w;canvas.height=size.h;return canvas.getContext("2d")};imagelib.drawing.copy=function(dstCtx,src,size){dstCtx.drawImage(src.canvas||src,0,0,size.w,size.h)};imagelib.drawing.clear=function(ctx,size){ctx.clearRect(0,0,size.w,size.h)};imagelib.drawing.drawCenterInside=function(dstCtx,src,dstRect,srcRect){if(srcRect.w/srcRect.h>dstRect.w/dstRect.h){var h=srcRect.h*dstRect.w/srcRect.w;dstCtx.drawImage(src.canvas||src,srcRect.x,srcRect.y,srcRect.w,srcRect.h,dstRect.x,dstRect.y+(dstRect.h-h)/2,dstRect.w,h)}else{var w=srcRect.w*dstRect.h/srcRect.h;dstCtx.drawImage(src.canvas||src,srcRect.x,srcRect.y,srcRect.w,srcRect.h,dstRect.x+(dstRect.w-w)/2,dstRect.y,w,dstRect.h)}};imagelib.drawing.drawCenterCrop=function(dstCtx,src,dstRect,srcRect){if(srcRect.w/srcRect.h>dstRect.w/dstRect.h){var w=srcRect.h*dstRect.w/dstRect.h;dstCtx.drawImage(src.canvas||src,srcRect.x+(srcRect.w-w)/2,srcRect.y,w,srcRect.h,dstRect.x,dstRect.y,dstRect.w,dstRect.h)}else{var h=srcRect.w*dstRect.h/dstRect.w;dstCtx.drawImage(src.canvas||src,srcRect.x,srcRect.y+(srcRect.h-h)/2,srcRect.w,h,dstRect.x,dstRect.y,dstRect.w,dstRect.h)}};imagelib.drawing.trimRectWorkerJS_=["self['onmessage'] = function(event) {                                       ","  var l = event.data.size.w, t = event.data.size.h, r = 0, b = 0;           ","                                                                            ","  var alpha;                                                                ","  for (var y = 0; y < event.data.size.h; y++) {                             ","    for (var x = 0; x < event.data.size.w; x++) {                           ","      alpha = event.data.imageData.data[                                    ","          ((y * event.data.size.w + x) << 2) + 3];                          ","      if (alpha >= event.data.minAlpha) {                                   ","        l = Math.min(x, l);                                                 ","        t = Math.min(y, t);                                                 ","        r = Math.max(x, r);                                                 ","        b = Math.max(y, b);                                                 ","      }                                                                     ","    }                                                                       ","  }                                                                         ","                                                                            ","  if (l > r) {                                                              ","    // no pixels, couldn't trim                                             ","    postMessage({ x: 0, y: 0, w: event.data.size.w, h: event.data.size.h });","  }                                                                         ","                                                                            ","  postMessage({ x: l, y: t, w: r - l + 1, h: b - t + 1 });                  ","};                                                                          ",""].join("\n");imagelib.drawing.getTrimRect=function(ctx,size,minAlpha,callback){callback=callback||function(){};if(!ctx.canvas){var src=ctx;ctx=imagelib.drawing.context(size);imagelib.drawing.copy(ctx,src,size)}if(minAlpha==0){callback({x:0,y:0,w:size.w,h:size.h})}minAlpha=minAlpha||1;var worker=imagelib.util.runWorkerJs(imagelib.drawing.trimRectWorkerJS_,{imageData:ctx.getImageData(0,0,size.w,size.h),size:size,minAlpha:minAlpha},callback);return worker};imagelib.drawing.copyAsAlpha=function(dstCtx,src,size,onColor,offColor){onColor=onColor||"#fff";offColor=offColor||"#000";dstCtx.save();dstCtx.clearRect(0,0,size.w,size.h);dstCtx.globalCompositeOperation="source-over";imagelib.drawing.copy(dstCtx,src,size);dstCtx.globalCompositeOperation="source-atop";dstCtx.fillStyle=onColor;dstCtx.fillRect(0,0,size.w,size.h);dstCtx.globalCompositeOperation="destination-atop";dstCtx.fillStyle=offColor;dstCtx.fillRect(0,0,size.w,size.h);dstCtx.restore()};imagelib.drawing.makeAlphaMask=function(ctx,size,fillColor){var src=ctx.getImageData(0,0,size.w,size.h);var dst=ctx.createImageData(size.w,size.h);var srcData=src.data;var dstData=dst.data;var i,g;for(var y=0;y<size.h;y++){for(var x=0;x<size.w;x++){i=(y*size.w+x)<<2;g=0.3*srcData[i]+0.59*srcData[i+1]+0.11*srcData[i+2];dstData[i]=dstData[i+1]=dstData[i+2]=255;dstData[i+3]=g}}ctx.putImageData(dst,0,0);if(fillColor){ctx.save();ctx.globalCompositeOperation="source-atop";ctx.fillStyle=fillColor;ctx.fillRect(0,0,size.w,size.h);ctx.restore()}};imagelib.drawing.applyFilter=function(filter,ctx,size){var src=ctx.getImageData(0,0,size.w,size.h);var dst=ctx.createImageData(size.w,size.h);filter.apply(src,dst);ctx.putImageData(dst,0,0)};imagelib.drawing.blur=function(radius,ctx,size){var rows=Math.ceil(radius);var r=rows*2+1;var matrix=new Array(r*r);var sigma=radius/3;var sigma22=2*sigma*sigma;var sqrtPiSigma22=Math.sqrt(Math.PI*sigma22);var radius2=radius*radius;var total=0;var index=0;var distance2;for(var y=-rows;y<=rows;y++){for(var x=-rows;x<=rows;x++){distance2=1*x*x+1*y*y;if(distance2>radius2){matrix[index]=0}else{matrix[index]=Math.exp(-distance2/sigma22)/sqrtPiSigma22}total+=matrix[index];index++}}imagelib.drawing.applyFilter(new ConvolutionFilter(matrix,total,0,true),ctx,size)};imagelib.drawing.fx=function(effects,dstCtx,src,size){effects=effects||[];var outerEffects=[];var innerEffects=[];var fillEffects=[];for(var i=0;i<effects.length;i++){if(/^outer/.test(effects[i].effect)){outerEffects.push(effects[i])}else{if(/^inner/.test(effects[i].effect)){innerEffects.push(effects[i])}else{if(/^fill/.test(effects[i].effect)){fillEffects.push(effects[i])}}}}var tmpCtx=imagelib.drawing.context(size);var tmpCtx2=imagelib.drawing.context(size);for(var i=0;i<outerEffects.length;i++){var effect=outerEffects[i];dstCtx.save();switch(effect.effect){case"outer-shadow":imagelib.drawing.clear(tmpCtx,size);imagelib.drawing.copyAsAlpha(tmpCtx,src.canvas||src,size);if(effect.blur){imagelib.drawing.blur(effect.blur,tmpCtx,size)}imagelib.drawing.makeAlphaMask(tmpCtx,size,effect.color||"#000");if(effect.translate){dstCtx.translate(effect.translate.x||0,effect.translate.y||0)}dstCtx.globalAlpha=Math.max(0,Math.min(1,effect.opacity||1));imagelib.drawing.copy(dstCtx,tmpCtx,size);break}dstCtx.restore()}dstCtx.save();imagelib.drawing.clear(tmpCtx,size);imagelib.drawing.copy(tmpCtx,src.canvas||src,size);if(fillEffects.length){var effect=fillEffects[0];tmpCtx.save();tmpCtx.globalCompositeOperation="source-atop";switch(effect.effect){case"fill-color":tmpCtx.fillStyle=effect.color;break;case"fill-lineargradient":var gradient=tmpCtx.createLinearGradient(effect.from.x,effect.from.y,effect.to.x,effect.to.y);for(var i=0;i<effect.colors.length;i++){gradient.addColorStop(effect.colors[i].offset,effect.colors[i].color)}tmpCtx.fillStyle=gradient;break}tmpCtx.fillRect(0,0,size.w,size.h);tmpCtx.restore()}dstCtx.globalAlpha=1;imagelib.drawing.copy(dstCtx,tmpCtx,size);for(var i=0;i<innerEffects.length;i++){var effect=innerEffects[i];tmpCtx.save();switch(effect.effect){case"inner-shadow":imagelib.drawing.clear(tmpCtx,size);imagelib.drawing.copyAsAlpha(tmpCtx,src.canvas||src,size,"#fff","#000");imagelib.drawing.copyAsAlpha(tmpCtx2,src.canvas||src,size);if(effect.blur){imagelib.drawing.blur(effect.blur,tmpCtx2,size)}imagelib.drawing.makeAlphaMask(tmpCtx2,size,"#000");if(effect.translate){tmpCtx.translate(effect.translate.x||0,effect.translate.y||0)}tmpCtx.globalCompositeOperation="source-over";imagelib.drawing.copy(tmpCtx,tmpCtx2,size);imagelib.drawing.makeAlphaMask(tmpCtx,size,effect.color);dstCtx.globalAlpha=Math.max(0,Math.min(1,effect.opacity||1));imagelib.drawing.copy(dstCtx,tmpCtx,size);break}tmpCtx.restore()}dstCtx.restore()};imagelib.loadImageResources=function(images,callback){var imageResources={};var checkForCompletion=function(){for(var id in images){if(!(id in imageResources)){return}}(callback||function(){})(imageResources);callback=null};for(var id in images){var img=document.createElement("img");img.src=images[id];(function(img,id){img.onload=function(){imageResources[id]=img;checkForCompletion()};img.onerror=function(){imageResources[id]=null;checkForCompletion()}})(img,id)}};imagelib.loadFromUri=function(uri,callback){callback=callback||function(){};var img=document.createElement("img");img.src=uri;img.onload=function(){callback(img)};img.onerror=function(){callback(null)}};imagelib.toDataUri=function(img){var canvas=document.createElement("canvas");canvas.width=img.naturalWidth;canvas.height=img.naturalHeight;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);return canvas.toDataURL()};imagelib.util={};imagelib.util.runWorkerJs=function(js,params,callback){var BlobBuilder=(window.BlobBuilder||window.WebKitBlobBuilder);var URL=(window.URL||window.webkitURL);var Worker=window.Worker;if(URL&&BlobBuilder&&Worker){var bb=new BlobBuilder();bb.append(js);var worker=new Worker(URL.createObjectURL(bb.getBlob()));worker.onmessage=function(event){callback(event.data)};worker.postMessage(params);return worker}else{(function(){var __DUMMY_OBJECT__={};var postMessage=function(result){callback(result)};eval("var self=__DUMMY_OBJECT__;\n"+js);__DUMMY_OBJECT__.onmessage({data:params})})();return{terminate:function(){}}}};window.imagelib=imagelib})();(function(){var b={};b.checkBrowser=function(){var c=navigator.userAgent.match(/Chrome\/(\d+)/);var e=false;if(c){var d=parseInt(c[1],10);if(d>=6){e=true}}if(!e){$("<div>").addClass("browser-unsupported-note ui-state-highlight").attr("title","Your browser is not supported.").append($('<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;">')).append($("<p>").html('Currently only <a href="http://www.google.com/chrome">Google Chrome</a> is recommended and supported. Your mileage may vary with other browsers.')).prependTo("body")}};(function(c){c.widget("ui.combobox",{_create:function(){var f=this,d=this.element.hide(),g=d.children(":selected"),h=g.val()?g.text():"";var e=c("<input>").insertAfter(d).val(h).autocomplete({delay:0,minLength:0,source:function(j,i){var l=new RegExp(c.ui.autocomplete.escapeRegex(j.term),"i");i(d.children("option").map(function(){var m=c(this).text();if(this.value&&(!j.term||l.test(m))){return{label:m.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c.ui.autocomplete.escapeRegex(j.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"),value:m,option:this}}}))},select:function(i,j){j.item.option.selected=true;f._trigger("selected",i,{item:j.item.option})},change:function(j,l){if(!l.item){var m=new RegExp("^"+c.ui.autocomplete.escapeRegex(c(this).val())+"$","i"),i=false;d.children("option").each(function(){if(this.value.match(m)){this.selected=i=true;return false}});if(!i){c(this).val("");d.val("");return false}}}}).addClass("ui-widget ui-widget-content ui-corner-left");e.data("autocomplete")._renderItem=function(i,j){return c("<li></li>").data("item.autocomplete",j).append("<a>"+j.label+"</a>").appendTo(i)};c("<button>&nbsp;</button>").attr("tabIndex",-1).attr("title","Show All Items").insertAfter(e).button({icons:{primary:"ui-icon-triangle-1-s"},text:false}).removeClass("ui-corner-all").addClass("ui-corner-right ui-button-icon").click(function(){if(e.autocomplete("widget").is(":visible")){e.autocomplete("close");return}e.autocomplete("search","");e.focus()})}})})(jQuery);(function(c){c.widget("ui.autocompletewithbutton",{_create:function(){var e=this,d=this.element,f=d.text();d.autocomplete(c.extend(this.options,{select:function(g,h){e._trigger("selected",g,h.item.value)}})).addClass("form-text ui-widget ui-widget-content ui-corner-left ui-autocomplete-input");d.data("autocomplete")._renderItem=function(g,h){return c("<li></li>").data("item.autocomplete",h).append("<a>"+h.label+"</a>").appendTo(g)};c("<button>&nbsp;</button>").attr("tabIndex",-1).attr("title","Show All Items").insertAfter(d).button({icons:{primary:"ui-icon-triangle-1-s"},text:false}).removeClass("ui-corner-all").addClass("ui-corner-right ui-button-icon").click(function(){if(d.autocomplete("widget").is(":visible")){d.autocomplete("close");return}d.autocomplete("search","");d.focus()})}})})(jQuery);b.forms={};b.forms.Form=Base.extend({constructor:function(e,d){this.id_=e;this.params_=d;this.fields_=d.fields;this.pauseNotify_=false;for(var c=0;c<this.fields_.length;c++){this.fields_[c].setForm_(this)}this.onChange=this.params_.onChange||function(){}},createUI:function(c){for(var d=0;d<this.fields_.length;d++){var e=this.fields_[d];e.createUI(c)}},notifyChanged_:function(){if(this.pauseNotify_){return}this.onChange()},getValues:function(){var c={};for(var d=0;d<this.fields_.length;d++){var e=this.fields_[d];c[e.id_]=e.getValue()}return c},getValuesSerialized:function(){var c={};for(var d=0;d<this.fields_.length;d++){var f=this.fields_[d];var e=f.serializeValue?f.serializeValue():undefined;if(e!==undefined){c[f.id_]=f.serializeValue()}}return c},setValuesSerialized:function(d){this.pauseNotify_=true;for(var c=0;c<this.fields_.length;c++){var e=this.fields_[c];if(e.id_ in d&&e.deserializeValue){e.deserializeValue(d[e.id_])}}this.pauseNotify_=false;this.notifyChanged_()}});b.forms.Field=Base.extend({constructor:function(d,c){this.id_=d;this.params_=c},setForm_:function(c){this.form_=c},getLongId:function(){return this.form_.id_+"-"+this.id_},getHtmlId:function(){return"_frm-"+this.getLongId()},createUI:function(c){c=$(c);return $("<div>").addClass("form-field-outer").append($("<label>").attr("for",this.getHtmlId()).text(this.params_.title).append($("<div>").addClass("form-field-help-text").css("display",this.params_.helpText?"":"none").html(this.params_.helpText))).append($("<div>").addClass("form-field-container")).appendTo(c)}});b.forms.TextField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<input>").addClass("form-text ui-widget ui-widget-content ui-autocomplete-input ui-corner-all").attr("type","text").val(this.getValue()).bind("keydown change",function(){var f=this;window.setTimeout(function(){d.setValue($(f).val(),true)},0)}).appendTo(e)},getValue:function(){var c=this.value_;if(typeof c!="string"){c=this.params_.defaultValue||""}return c},setValue:function(d,c){this.value_=d;if(!c){$(this.el_).val(d)}this.form_.notifyChanged_()},serializeValue:function(){return this.getValue()},deserializeValue:function(c){this.setValue(c)}});b.forms.AutocompleteTextField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<input>").attr("type","text").val(this.getValue()).bind("keydown change",function(){var f=this;window.setTimeout(function(){d.setValue($(f).val(),true)},0)}).appendTo(e);this.el_.autocompletewithbutton({source:this.params_.items||[],delay:0,minLength:0,selected:function(f,g){d.setValue(g,true)}})},getValue:function(){var c=this.value_;if(typeof c!="string"){c=this.params_.defaultValue||""}return c},setValue:function(d,c){this.value_=d;if(!c){$(this.el_).val(d)}this.form_.notifyChanged_()},serializeValue:function(){return this.getValue()},deserializeValue:function(c){this.setValue(c)}});b.forms.ColorField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<div>").addClass("form-color").attr("id",this.getHtmlId()).append($("<div>").addClass("form-color-preview").css("background-color",this.getValue().color)).button({label:null,icons:{secondary:"ui-icon-carat-1-s"}}).appendTo(e);this.el_.ColorPicker({color:this.getValue().color,onChange:function(f,h,g){d.setValue({color:"#"+h},true)}});if(this.params_.alpha){this.alphaEl_=$("<div>").addClass("form-color-alpha").slider({min:0,max:100,range:"min",value:this.getValue().alpha,slide:function(f,g){d.setValue({alpha:g.value},true)}}).appendTo(e)}},getValue:function(){var c=this.value_||this.params_.defaultValue||"#000000";if(/^([0-9a-f]{6}|[0-9a-f]{3})$/i.test(c)){c="#"+c}var d=this.alpha_;if(typeof d!="number"){d=this.params_.defaultAlpha;if(typeof d!="number"){d=100}}return{color:c,alpha:d}},setValue:function(e,d){e=e||{};if("color" in e){this.value_=e.color}if("alpha" in e){this.alpha_=e.alpha}var c=this.getValue();$(".form-color-preview",this.el_).css("background-color",c.color);if(!d){$(this.el_).ColorPickerSetColor(c.color);if(this.alphaEl_){$(this.alphaEl_).slider("value",c.alpha)}}this.form_.notifyChanged_()},serializeValue:function(){var c=this.getValue();return c.color.replace(/^#/,"")+","+c.alpha},deserializeValue:function(d){var e={};var c=d.split(",",2);if(c.length>=1){e.color=c[0]}if(c.length>=2){e.alpha=parseInt(c[1],10)}this.setValue(e)}});b.forms.EnumField=b.forms.Field.extend({createUI:function(c){var g=$(".form-field-container",this.base(c));var f=this;if(this.params_.buttons){this.el_=$("<div>").attr("id",this.getHtmlId()).addClass(".form-field-buttonset").appendTo(g);for(var d=0;d<this.params_.options.length;d++){var e=this.params_.options[d];$("<input>").attr({type:"radio",name:this.getHtmlId(),id:this.getHtmlId()+"-"+e.id,value:e.id}).change(function(){f.setValueInternal_($(this).val(),true)}).appendTo(this.el_);$("<label>").attr("for",this.getHtmlId()+"-"+e.id).text(e.title).appendTo(this.el_)}this.setValueInternal_(this.getValue());this.el_.buttonset()}else{this.el_=$("<select>").attr("id",this.getHtmlId()).change(function(){f.setValueInternal_($(this).val(),true)}).appendTo(g);for(var d=0;d<this.params_.options.length;d++){var e=this.params_.options[d];$("<option>").attr("value",e.id).text(e.title).appendTo(this.el_)}this.el_.combobox({selected:function(h,i){f.form_.notifyChanged_()}})}},getValue:function(){var c=this.value_;if(c===undefined){c=this.params_.defaultValue||this.params_.options[0].id}return c},setValue:function(d,c){this.setValueInternal_(d,c)},setValueInternal_:function(d,c){this.value_=d;if(!c){if(this.params_.buttons){$("input",this.el_).each(function(e,f){$(f).attr("checked",$(f).val()==d)});$(this.el_).buttonset("refresh")}else{this.el_.val(d)}}this.form_.notifyChanged_()},serializeValue:function(){return this.getValue()},deserializeValue:function(c){this.setValue(c)}});b.forms.BooleanField=b.forms.EnumField.extend({constructor:function(d,c){c.options=[{id:"1",title:c.onText||"Yes"},{id:"0",title:c.offText||"No"}];c.defaultValue=c.defaultValue?"1":"0";c.buttons=true;this.base(d,c)},getValue:function(){return this.base()=="1"},setValue:function(d,c){this.base(d?"1":"0",c)},serializeValue:function(){return this.getValue()?"1":"0"},deserializeValue:function(c){this.setValue(c=="1")}});b.forms.RangeField=b.forms.Field.extend({createUI:function(c){var e=$(".form-field-container",this.base(c));var d=this;this.el_=$("<div>").addClass("form-range").slider({min:this.params_.min||0,max:this.params_.max||100,step:this.params_.step||1,range:"min",value:this.getValue(),slide:function(f,g){d.setValue(g.value,true)}}).appendTo(e);if(this.params_.textFn||this.params_.showText){this.params_.textFn=this.params_.textFn||function(f){return f};this.textEl_=$("<div>").addClass("form-range-text").text(this.params_.textFn(this.getValue())).appendTo(e)}},getValue:function(){var c=this.value_;if(typeof c!="number"){c=this.params_.defaultValue;if(typeof c!="number"){c=0}}return c},setValue:function(d,c){this.value_=d;if(!c){$(this.el_).slider("value",d)}if(this.textEl_){this.textEl_.text(this.params_.textFn(d))}this.form_.notifyChanged_()},serializeValue:function(){return this.getValue().toString()},deserializeValue:function(c){this.setValue(Number(c))}});b.hash={};b.hash.boundFormOldOnChange_=null;b.hash.boundForm_=null;b.hash.currentParams_={};b.hash.currentHash_=null;b.hash.bindFormToDocumentHash=function(d){if(!b.hash.boundForm_){var e=function(){var f=b.hash.paramsToHash(b.hash.hashToParams((document.location.href.match(/#.*/)||[""])[0]));if(f!=b.hash.currentHash_){var g=f;var h=b.hash.hashToParams(g);b.hash.onHashParamsChanged_(h);b.hash.currentParams_=h;b.hash.currentHash_=g}window.setTimeout(e,100)};window.setTimeout(e,0)}if(b.hash.boundFormOldOnChange_&&b.hash.boundForm_){b.hash.boundForm_.onChange=b.hash.boundFormOldOnChange_}b.hash.boundFormOldOnChange_=d.onChange;b.hash.boundForm_=d;var c=null;b.hash.boundForm_.onChange=function(){if(c){window.clearTimeout(c)}c=window.setTimeout(function(){b.hash.onFormChanged_()},500);(b.hash.boundFormOldOnChange_||function(){}).apply(d,arguments)}};b.hash.onHashParamsChanged_=function(c){if(b.hash.boundForm_){b.hash.boundForm_.setValuesSerialized(c)}};b.hash.onFormChanged_=function(){if(b.hash.boundForm_){b.hash.currentParams_=b.hash.boundForm_.getValuesSerialized();b.hash.currentHash_=b.hash.paramsToHash(b.hash.currentParams_);document.location.hash=b.hash.currentHash_}};b.hash.hashToParams=function(l){var e={};l=l.replace(/^[?#]/,"");var c=l.split("&");for(var m=0;m<c.length;m++){var g=c[m].split("=",2);var p=g[0]?decodeURIComponent(g[0]):g[0];var d=g[1]?decodeURIComponent(g[1]):g[1];var n=p.split(".");var h=e;for(var f=0;f<n.length-1;f++){h[n[f]]=h[n[f]]||{};h=h[n[f]]}var o=n[n.length-1];if(o in h){if(h[o]&&h[o].splice){h[o].push(d)}else{h[o]=[h[o],d]}}else{h[o]=d}}return e};b.hash.paramsToHash=function(l,f){var c=[];var h=function(i){return encodeURIComponent((f?f+".":"")+i)};var g=function(m,i){if(i===false){i=0}if(i===true){i=1}c.push(h(m)+"="+encodeURIComponent(i.toString()))};for(var e in l){var j=l[e];if(j===undefined||j===null){continue}if(typeof j=="object"){if(j.splice&&j.length){for(var d=0;d<j.length;d++){g(e,j[d])}}else{c.push(b.hash.paramsToHash(j,h(e)))}}else{g(e,j)}}return c.join("&")};var a=window.canvg&&true;b.forms.ImageField=b.forms.Field.extend({constructor:function(d,c){this.valueType_=null;this.textParams_={};this.imageParams_={};this.spaceFormValues_={};this.base(d,c)},createUI:function(d){var j=this.base(d);var h=$(".form-field-container",j);var m=this;j.addClass("form-field-drop-target");j.get(0).ondragenter=b.forms.ImageField.makeDragenterHandler_(j);j.get(0).ondragleave=b.forms.ImageField.makeDragleaveHandler_(j);j.get(0).ondragover=b.forms.ImageField.makeDragoverHandler_(j);j.get(0).ondrop=b.forms.ImageField.makeDropHandler_(j,function(i){m.loadFromFileList_(i.dataTransfer.files,function(q){if(!q){return}m.setValueType_("image");m.imageParams_=q;m.valueFilename_=q.name;m.renderValueAndNotifyChanged_()})});this.el_=$("<div>").attr("id",this.getHtmlId()).addClass(".form-field-buttonset").appendTo(h);var l=["image","Image","clipart","Clipart","text","Text"];var e={};for(var g=0;g<l.length/2;g++){$("<input>").attr({type:"radio",name:this.getHtmlId(),id:this.getHtmlId()+"-"+l[g*2],value:l[g*2]}).appendTo(this.el_);e[l[g*2]]=$("<label>").attr("for",this.getHtmlId()+"-"+l[g*2]).text(l[g*2+1]).appendTo(this.el_)}this.el_.buttonset();this.fileEl_=$("<input>").addClass("form-image-hidden-file-field").attr({id:this.getHtmlId(),type:"file",accept:"image/*"}).change(function(){m.loadFromFileList_(m.fileEl_.get(0).files,function(i){if(!i){return}m.setValueType_("image");m.imageParams_=i;m.valueFilename_=i.name;m.renderValueAndNotifyChanged_()})}).appendTo(this.el_);e.image.click(function(i){m.fileEl_.trigger("click");m.setValueType_(null);m.renderValueAndNotifyChanged_();i.preventDefault();return false});var c=$("<div>").addClass("form-image-type-params form-image-type-params-clipart").hide().appendTo(this.el_);var p=$("<div>").addClass("form-image-clipart-list").appendTo(c);for(var g=0;g<b.forms.ImageField.clipartList_.length;g++){var n="res/clipart/"+b.forms.ImageField.clipartList_[g];$("<img>").addClass("form-image-clipart-item").attr("src",n).click(function(i){return function(){m.loadClipart_(i)}}(n)).appendTo(p)}var o=$("<div>").addClass("form-image-clipart-attribution").html(["Clipart courtesy of ",'<a href="http://www.yay.se/2011/02/','native-android-icons-in-vector-format/"',' target="_blank">Olof Brickarp</a>.'].join("")).appendTo(c);e.clipart.click(function(i){m.setValueType_("clipart");m.renderValueAndNotifyChanged_()});var f=$("<div>").addClass("form-subform form-image-type-params form-image-type-params-text").hide().appendTo(this.el_);this.textForm_=new b.forms.Form(this.form_.id_+"-"+this.id_+"-textform",{onChange:function(){var i=m.textForm_.getValues();m.textParams_.text=i.text;m.textParams_.fontStack=i.font?i.font:"sans-serif";m.valueFilename_=i.text;m.renderValueAndNotifyChanged_()},fields:[new b.forms.TextField("text",{title:"Text",}),new b.forms.AutocompleteTextField("font",{title:"Font",items:b.forms.ImageField.fontList_}),]});this.textForm_.createUI(f);e.text.click(function(i){m.setValueType_("text");m.renderValueAndNotifyChanged_()});this.spaceFormValues_={};this.spaceForm_=new b.forms.Form(this.form_.id_+"-"+this.id_+"-spaceform",{onChange:function(){m.spaceFormValues_=m.spaceForm_.getValues();m.renderValueAndNotifyChanged_()},fields:[new b.forms.BooleanField("trim",{title:"Trim",defaultValue:this.params_.defaultValueTrim||false,offText:"Don't Trim",onText:"Trim"}),new b.forms.RangeField("pad",{title:"Padding",defaultValue:0,min:-0.1,max:0.5,step:0.05,textFn:function(i){return(i*100)+"%"}}),]});this.spaceForm_.createUI($("<div>").addClass("form-subform").appendTo(h));this.spaceFormValues_=this.spaceForm_.getValues();this.imagePreview_=$("<canvas>").addClass("form-image-preview").hide().appendTo(h.parent())},setValueType_:function(c){this.valueType_=c;$("label",this.el_).removeClass("ui-state-active");$(".form-image-type-params",this.el_).hide();if(c){$("label[for="+this.getHtmlId()+"-"+c+"]").addClass("ui-state-active");$(".form-image-type-params-"+c,this.el_).show()}},loadClipart_:function(c){var d=a&&c.match(/\.svg$/);$("img.form-image-clipart-item",this.el_).removeClass("selected");$('img[src="'+c+'"]').addClass("selected");this.imageParams_={canvgSvgUri:d?c:null,uri:d?null:c};this.clipartSrc_=c;this.valueFilename_=c.match(/[^/]+$/)[0];this.renderValueAndNotifyChanged_()},loadFromFileList_:function(d,j){d=d||[];var h=this;var f=null;for(var e=0;e<d.length;e++){if(b.forms.ImageField.isValidFile_(d[e])){f=d[e];break}}if(!f){alert("Please choose a valid image file (PNG, JPG, GIF, SVG, etc.)");j(null);return}var g=a&&f.type=="image/svg+xml";var c=new FileReader();c.onload=function(i){j({uri:g?null:i.target.result,canvgSvgText:g?i.target.result:null,name:f.name})};c.onerror=function(i){switch(i.target.error.code){case i.target.error.NOT_FOUND_ERR:alert("File not found!");break;case i.target.error.NOT_READABLE_ERR:alert("File is not readable");break;case i.target.error.ABORT_ERR:break;default:alert("An error occurred reading this file.")}j(null)};c.onabort=function(i){alert("File read cancelled");j(null)};if(g){c.readAsText(f)}else{c.readAsDataURL(f)}},clearValue:function(){this.valueType_=null;this.valueFilename_=null;this.valueCtx_=null;this.fileEl_.val("");this.imagePreview_.hide()},getValue:function(){return{ctx:this.valueCtx_,name:this.valueFilename_}},renderValueAndNotifyChanged_:function(){if(!this.valueType_){this.valueCtx_=null}var g=this;switch(this.valueType_){case"image":case"clipart":if(this.imageParams_.canvgSvgText||this.imageParams_.canvgSvgUri){var e=document.createElement("canvas");var f={w:800,h:800};e.className="offscreen";e.width=f.w;e.height=f.h;document.body.appendChild(e);canvg(e,this.imageParams_.canvgSvgText||this.imageParams_.canvgSvgUri,{scaleWidth:f.w,scaleHeight:f.h,ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true});d(e.getContext("2d"),f);document.body.removeChild(e)}else{if(this.imageParams_.uri){imagelib.loadFromUri(this.imageParams_.uri,function(l){var m={w:l.naturalWidth,h:l.naturalHeight};var j=imagelib.drawing.context(m);imagelib.drawing.copy(j,l,m);d(j,m)})}}break;case"text":var f={w:4000,h:800};var c=imagelib.drawing.context(f);var h=this.textParams_.text||"";c.fillStyle="#000";c.font="bold "+f.h+"px/"+f.h+"px "+(this.textParams_.fontStack||"sans-serif");c.textBaseline="bottom";c.fillText(h,0,f.h);f.w=Math.min(c.measureText(h).width,f.w)||f.w;d(c,f);break;default:g.form_.notifyChanged_()}function d(l,j){if(g.spaceFormValues_.trim){if(g.trimWorker_){g.trimWorker_.terminate()}g.trimWorker_=imagelib.drawing.getTrimRect(l,j,1,function(m){i(l,j,m)})}else{i(l,j,{x:0,y:0,w:j.w,h:j.h})}}function i(o,m,n){var r=g.spaceFormValues_.trim?0.001:0;if(n.x==0&&n.y==0&&n.w==m.w&&n.h==m.h){r=0}var q=((g.spaceFormValues_.pad||0)+r)*Math.min(n.w,n.h);var p={x:q,y:q,w:n.w,h:n.h};var l=imagelib.drawing.context({w:n.w+q*2,h:n.h+q*2});imagelib.drawing.drawCenterInside(l,o,p,n);g.valueCtx_=l;if(g.imagePreview_){g.imagePreview_.attr("width",l.canvas.width);g.imagePreview_.attr("height",l.canvas.height);var j=g.imagePreview_.get(0).getContext("2d");j.drawImage(l.canvas,0,0);g.imagePreview_.show()}g.form_.notifyChanged_()}},serializeValue:function(){return{type:this.valueType_,space:this.spaceForm_.getValuesSerialized(),clipart:(this.valueType_=="clipart")?this.clipartSrc_:null,text:(this.valueType_=="text")?this.textForm_.getValuesSerialized():null}},deserializeValue:function(c){if(c.type){this.setValueType_(c.type)}if(c.space){this.spaceForm_.setValuesSerialized(c.space);this.spaceFormValues_=this.spaceForm_.getValues()}if(c.clipart&&this.valueType_=="clipart"){this.loadClipart_(c.clipart)}if(c.text&&this.valueType_=="text"){this.textForm_.setValuesSerialized(c.text)}}});b.forms.ImageField.clipartList_=["icons/accounts.svg","icons/add.svg","icons/agenda.svg","icons/all_friends.svg","icons/attachment.svg","icons/back.svg","icons/backspace.svg","icons/barcode.svg","icons/battery_charging.svg","icons/bell.svg","icons/block.svg","icons/block_user.svg","icons/bookmarks.svg","icons/camera.svg","icons/circle_arrow.svg","icons/clock.svg","icons/compass.svg","icons/cross.svg","icons/cross2.svg","icons/directions.svg","icons/down_arrow.svg","icons/edit.svg","icons/expand_arrows.svg","icons/export.svg","icons/eye.svg","icons/gallery.svg","icons/group.svg","icons/happy_droid.svg","icons/help.svg","icons/home.svg","icons/info.svg","icons/key.svg","icons/list.svg","icons/lock.svg","icons/mail.svg","icons/map.svg","icons/map_pin.svg","icons/mic.svg","icons/notification.svg","icons/phone.svg","icons/play_clip.svg","icons/plus.svg","icons/position.svg","icons/power.svg","icons/refresh.svg","icons/search.svg","icons/settings.svg","icons/share.svg","icons/slideshow.svg","icons/sort_by_size.svg","icons/sound_full.svg","icons/sound_off.svg","icons/star.svg","icons/stars_grade.svg","icons/stop.svg","icons/trashcan.svg","icons/usb.svg","icons/user.svg","icons/warning.svg"];b.forms.ImageField.fontList_=["Helvetica","Arial","Georgia","Book Antiqua","Palatino","Courier","Courier New","Webdings","Wingdings"];b.forms.ImageField.isValidFile_=function(c){return !!c.type.toLowerCase().match(/^image\//)};b.forms.ImageField.makeDropHandler_=function(d,c){return function(e){$(d).removeClass("drag-hover");c(e)}};b.forms.ImageField.makeDragoverHandler_=function(c){return function(d){c=$(c).get(0);if(c._studio_frm_dragtimeout_){window.clearTimeout(c._studio_frm_dragtimeout_);c._studio_frm_dragtimeout_=null}d.dataTransfer.dropEffect="link";d.preventDefault()}};b.forms.ImageField.makeDragenterHandler_=function(c){return function(d){c=$(c).get(0);if(c._studio_frm_dragtimeout_){window.clearTimeout(c._studio_frm_dragtimeout_);c._studio_frm_dragtimeout_=null}$(c).addClass("drag-hover");d.preventDefault()}};b.forms.ImageField.makeDragleaveHandler_=function(c){return function(d){c=$(c).get(0);if(c._studio_frm_dragtimeout_){window.clearTimeout(c._studio_frm_dragtimeout_)}c._studio_frm_dragtimeout_=window.setTimeout(function(){$(c).removeClass("drag-hover")},100)}};b.ui={};b.ui.createImageOutputGroup=function(c){return $("<div>").addClass("out-image-group").append($("<div>").addClass("label").text(c.label)).appendTo(c.container)};b.ui.createImageOutputSlot=function(c){return $("<div>").addClass("out-image-block").append($("<div>").addClass("label").text(c.label)).append($("<img>").addClass("out-image").attr("id",c.id)).appendTo(c.container)};b.ui.drawImageGuideRects=function(c,e,f){f=f||[];c.save();c.globalAlpha=0.5;c.fillStyle="#fff";c.fillRect(0,0,e.w,e.h);c.globalAlpha=1;var g=b.ui.drawImageGuideRects.guideColors_;for(var d=0;d<f.length;d++){c.strokeStyle=g[(d-1)%g.length];c.strokeRect(f[d].x+0.5,f[d].y+0.5,f[d].w-1,f[d].h-1)}c.restore()};b.ui.drawImageGuideRects.guideColors_=["#f00"];b.util={};b.util.getMultBaseHdpi=function(c){switch(c){case"xhdpi":return 1.333333;case"hdpi":return 1;case"mdpi":return 0.666667;case"ldpi":return 0.5}return 1};b.util.mult=function(c,e){var f={};for(k in c){f[k]=c[k]*e}return f};b.util.multRound=function(c,e){var f={};for(k in c){f[k]=Math.round(c[k]*e)}return f};b.zip={};b.zip.createDownloadifyZipButton=function(e,d){var c={fileSpecs_:[]};d=d||{};d.swf=d.swf||"lib/downloadify/media/downloadify.swf";d.downloadImage=d.downloadImage||"images/download-zip-button.png";d.width=d.width||133;d.height=d.height||30;d.dataType="base64";d.onError=d.onError||function(){if(c.fileSpecs_.length){alert("There was an error downloading the .zip")}};d.filename=function(){return c.zipFilename_||"output.zip"};d.data=function(){if(!c.fileSpecs_.length){return""}var h=new JSZip();for(var g=0;g<c.fileSpecs_.length;g++){var j=c.fileSpecs_[g];if(j.base64data){h.add(j.name,j.base64data,{base64:true})}else{if(j.textData){h.add(j.name,j.textData)}}}return h.generate()};var f;if(window.Downloadify){f=Downloadify.create($(e).get(0),d)}c.setZipFilename=function(g){c.zipFilename_=g};c.clear=function(){c.fileSpecs_=[]};c.add=function(g){c.fileSpecs_.push(g)};return c};window.studio=b})();